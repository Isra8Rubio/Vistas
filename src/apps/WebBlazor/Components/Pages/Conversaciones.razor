@page "/conversaciones"
@using MudBlazor
@using API.APIService


    <!-- Panel para crear el job si falta ?jobId=... -->
    <MudPaper Class="pa-3 mb-3 mt-3" Elevation="2" Style="border-left:4px solid var(--mud-palette-primary);">


        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
            <MudDatePicker @bind-Date="FromDate"
                           Label="Fecha"
                           DateFormat="dd/MM/yyyy" />

            <MudButton OnClick="CreateAndLoadJob"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PlayArrow">
                Crear job y cargar
            </MudButton>
        </MudStack>
    </MudPaper>

<MudGrid Class="mt-0">
    <MudItem xs="12" md="10">
        <MudDataGrid @ref="dataGrid"
                     T="ConversationListItemDTO"
                     ServerData="ServerReload"
                     Dense="true"
                     Hover="true"
                     Bordered="true"
                     Striped="true"
                     RowClick="GotoConversation"
                     Class="mt-1 pa-2"
                     Elevation="2">

            <ToolBarContent>
                <MudStack Row AlignItems="AlignItems.Center" Style="width:100%" Class="pa-1 mb-4">

                    <MudSpacer />

                    <!-- Buscar -->
                    <MudTextField T="string"
                                  @bind-Value="Search"
                                  Label="Buscar"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  AdornmentColor="Color.Primary"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="mt-2 mb-1" />
                    <MudIconButton Icon="@Icons.Material.Filled.Clear" OnClick="ClearFilters" Class="ml-1 mt-2" />
                </MudStack>
            </ToolBarContent>

            <Columns>
                <!-- Contacto (RemoteDisplay) -->
                <PropertyColumn Property="x => x.RemoteDisplay"
                                Title="Contacto"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:28%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />

                <!-- Dirección -->
                <PropertyColumn Property="x => x.Direction"
                                Title="Dir."
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:8%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />

                <!-- Queue -->
                <PropertyColumn Property="x => x.QueueId"
                                Title="Queue"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:22%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />

                <!-- Última actividad (End si existe, si no Start) -->
                <TemplateColumn Title="Última actividad" Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600; white-space:nowrap"
                                CellStyle="width:18%; white-space:nowrap; text-align:center; cursor:pointer">
                    <CellTemplate>
                        @{
                            var when = context.Item.End ?? context.Item.Start;
                        }
                        @when.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                    </CellTemplate>
                </TemplateColumn>

                <!-- Duración conectada (s) -->
                <TemplateColumn Title="Duración (s)" Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600; white-space:nowrap"
                                CellStyle="width:12%; text-align:center; cursor:pointer">
                    <CellTemplate>
                        @{
                            var secs = (context.Item.DurationConnectedMs ?? 0) / 1000;
                        }
                        <MudChip Variant="Variant.Outlined">@secs</MudChip>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <!-- Paginación -->
            <PagerContent>
                <MudDataGridPager T="ConversationListItemDTO" RowsPerPageString="Filas por página:" />
            </PagerContent>

        </MudDataGrid>
    </MudItem>
</MudGrid>
