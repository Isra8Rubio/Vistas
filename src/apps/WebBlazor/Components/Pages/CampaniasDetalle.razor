@page "/campanias/{id}"
@using MudBlazor
@using API.APIService
@inject APIClient Api
@inject NavigationManager Nav

<MudStack Row="true"
          AlignItems="AlignItems.Center"
          Class="pa-2 mt-4">
    <MudButton Variant="Variant.Outlined"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.ArrowBack"
               OnClick="@Back">
        Volver a Campañas
    </MudButton>
</MudStack>

@if (loading)
{
    <MudPaper Class="pa-4 mt-3 mx-auto" Style="max-width: 1000px;">
        <MudSkeleton Width="300px" Height="28px" />
        <MudSkeleton Width="220px" Height="18px" Class="mt-2" />
        <MudDivider Class="my-3" />
        @for (var i = 0; i < 6; i++)
        {
            <MudSkeleton Width="100%" Height="44px" Class="mt-2" />
        }
    </MudPaper>
}
else if (error is not null)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Elevation="0" Class="mt-3 mx-auto" Style="max-width: 1000px;">
        @error
        <MudButton OnClick="Reload" Color="Color.Error" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Refresh" Class="ml-2">
            Reintentar
        </MudButton>
    </MudAlert>
}
else
{
    <MudCard Class="pa-0 mt-3 mx-auto" Style="max-width: 1000px; border-radius: 12px; overflow: hidden;">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">@(_queue?.Name ?? "Campaña")</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @if (_queue?.DateModified is not null)
                    {
                        <text>Modificada: @_queue.DateModified?.ToString("dd/MM/yyyy HH:mm")</text>
                        ;
                    }
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudChip T="string" Variant="Variant.Outlined">
                    Miembros: @(_queue?.MemberCount ?? 0)
                </MudChip>
            </CardHeaderActions>
        </MudCardHeader>

        <MudDivider />

        <MudCardContent Class="pa-4">
            <MudText Typo="Typo.subtitle2" Class="mb-2">Miembros</MudText>

            <MudDataGrid T="UserDTO"
                         ServerData="LoadMembers"
                         Hover="true"
                         Bordered="true"
                         Striped="true">

                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="Usuario" />
                    <PropertyColumn Property="x => x.Email" Title="Email" />
                </Columns>

                <PagerContent>
                    <MudDataGridPager T="UserDTO" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter] public string? id { get; set; }

    private QueueDTO? _queue;
    private bool loading = true;
    private string? error;

    protected override async Task OnParametersSetAsync()
    {
        loading = true; error = null; _queue = null;
        try
        {
            if (string.IsNullOrWhiteSpace(id))
            {
                error = "Id de campaña no válido.";
                return;
            }

            // Detalle de la cola (si tu API lo expone; si no, comenta este bloque)
            try
            {
                _queue = await Api.Routing_GetQueueByIdAsync(id);
            }
            catch
            {
                // Si no existe el endpoint en tu cliente, simplemente deja _queue en null
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task<GridData<UserDTO>> LoadMembers(GridState<UserDTO> state)
    {
        if (string.IsNullOrWhiteSpace(id))
            return new GridData<UserDTO> { Items = Array.Empty<UserDTO>(), TotalItems = 0 };

        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var listing = await Api.Routing_GetRoutingQueueMembersAsync(id!, pageSize, pageNumber);
            var items = listing?.Entities ?? new List<UserDTO>();
            var total = (int)(listing?.Total ?? items.Count);

            return new GridData<UserDTO> { Items = items.ToList(), TotalItems = total };
        }
        catch (Exception ex)
        {
            error = ex.Message;
            return new GridData<UserDTO> { Items = Array.Empty<UserDTO>(), TotalItems = 0 };
        }
    }

    private void Back() => Nav.NavigateTo("/campanias");

    private void Reload()
    {
        _ = OnParametersSetAsync();
        StateHasChanged();
    }
}
