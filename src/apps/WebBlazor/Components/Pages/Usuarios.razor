@page "/usuarios"
@using MudBlazor
@using API.APIService
@using System.Globalization
@using System.Text
@inject APIClient Api
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudGrid Class="mt-2">
    <!-- Columna izquierda: grid -->
    <MudItem xs="12" md="10">
        <MudDataGrid @ref="dataGrid"
                     T="UserDTO"
                     ServerData="ServerReload"
                     Dense="true"
                     Hover="true"
                     Bordered="true"
                     Striped="true"
                     RowClick="GotoUser"
                     Class="pa-2"
                     Style="font-variant-numeric: tabular-nums;">
            <ToolBarContent>
                <MudStack Row AlignItems="AlignItems.Center" Style="width:100%">
                    <!-- Export -->
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Download"
                               OnClick="ExportCsv">
                        Exportar CSV
                    </MudButton>

                    <MudSpacer />

                    <!-- Buscar -->
                    <MudTextField T="string"
                                  @bind-Value="Search"
                                  Label="Buscar"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  AdornmentColor="Color.Primary"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="mt-2 mb-1" />
                    <MudIconButton Icon="@Icons.Material.Filled.Clear" OnClick="ClearFilters" Class="ml-1 mt-2" />
                </MudStack>
            </ToolBarContent>

            <Columns>
                <PropertyColumn Property="x => x.Name"
                                Title="Usuario"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="max-width:260px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />
                <PropertyColumn Property="x => x.Email"
                                Title="Email"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="max-width:280px;" />

                <TemplateColumn Title="Grupos" Sortable="false" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600; white-space:nowrap"
                                CellStyle="text-align:left; white-space:normal;">
                    <CellTemplate>
                        @if (context.Item.ListaGrupos is { Count: > 0 })
                        {
                            <div style="display:flex; flex-wrap:wrap; gap:.25rem; align-items:center;">
                                @foreach (var g in context.Item.ListaGrupos)
                                {
                                    var label = !string.IsNullOrWhiteSpace(g?.Name) ? g!.Name : g?.Id;
                                    <MudTooltip Text="@($"Id: {g?.Id}")">
                                        <MudChip Size="Size.Small" Variant="Variant.Outlined" Class="mr-1 mb-1">
                                            @label
                                        </MudChip>
                                    </MudTooltip>
                                }
                            </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">—</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <PagerContent>
                <MudDataGridPager T="UserDTO" RowsPerPageString="Filas por página:" />
            </PagerContent>
        </MudDataGrid>
    </MudItem>
</MudGrid>

@code {
    private MudDataGrid<UserDTO>? dataGrid;
    private List<UserDTO> _lastItems = new();
    private UserDTO? seleccionado;
    private int _totalItems;

    // búsqueda
    private string? _search;
    private string? Search
    {
        get => _search;
        set { if (_search == value) return; _search = value; _ = dataGrid?.ReloadServerData(); }
    }

    private Task ClearFilters()
    {
        Search = null;
        seleccionado = null;
        return dataGrid?.ReloadServerData() ?? Task.CompletedTask;
    }

    // carga server-side
    private async Task<GridData<UserDTO>> ServerReload(GridState<UserDTO> state)
    {
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var data = await Api.Users_GetUsersAsync(pageNumber, pageSize);

            // Total robusto (si algún backend no manda Total)
            var total = data.Total > 0
              ? data.Total
              : (data.PageCount > 0 && data.PageSize > 0 ? data.PageCount * data.PageSize : data.Entities.Count);

            IEnumerable<UserDTO> items = data.Entities;

            if (!string.IsNullOrWhiteSpace(_search))
            {
                var q = _search.Trim();
                items = items.Where(x =>
                  (x.Name?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false) ||
                  (x.Email?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false) ||
                  (x.ListaGrupos?.Any(g => g?.Name?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false) ?? false));
            }

            var list = items.ToList();
            _lastItems = list;
            _totalItems = (int)total;
            // si no hay selección o ya no existe en esta página, limpia el panel
            if (seleccionado is not null && !list.Any(u => u.Id == seleccionado.Id))
                seleccionado = null;

            return new GridData<UserDTO> { TotalItems = (int)total, Items = list };
        }
        catch (ApiException ex)
        {
            Snackbar.Add($"No se pudo cargar usuarios: {ex.StatusCode}", Severity.Error);
            _lastItems = new();
            return new GridData<UserDTO> { TotalItems = 0, Items = [] };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"No se pudo cargar usuarios: {ex.Message}", Severity.Error);
            _lastItems = new();
            return new GridData<UserDTO> { TotalItems = 0, Items = [] };
        }
    }

    private void GotoUser(DataGridRowClickEventArgs<UserDTO> args)
    => Nav.NavigateTo($"/usuarios/{args.Item.Id}");

    // private void OnRowClick(DataGridRowClickEventArgs<UserDTO> args) => seleccionado = args.Item;

    private async Task ExportCsv()
    {
        // fila plana para CSV
        var rows = _lastItems.Select(u => new
        {
            Usuario = u.Name ?? "",
            Email = u.Email ?? "",
            Grupos = u.ListaGrupos is { Count: > 0 }
                    ? string.Join(" | ", u.ListaGrupos.Where(g => g is not null)
                                                      .Select(g => string.IsNullOrWhiteSpace(g!.Name) ? g.Id : g.Name))
                    : ""
        });

        var sb = new StringBuilder();
        using var sw = new StringWriter(sb);
        using (var csv = new CsvHelper.CsvWriter(sw, CultureInfo.GetCultureInfo("es-ES")))
        {
            // cabeceras
            csv.WriteField("Usuario"); csv.WriteField("Email"); csv.WriteField("Grupos");
            await csv.NextRecordAsync();

            foreach (var r in rows)
            {
                csv.WriteField(r.Usuario);
                csv.WriteField(r.Email);
                csv.WriteField(r.Grupos);
                await csv.NextRecordAsync();
            }
        }

        var csvContent = sb.ToString();
        var module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/DownloadCSV.js");
        await module.InvokeVoidAsync("saveFile", $"usuarios_{DateTime.Now:yyyyMMdd_HHmm}.csv", csvContent);
    }
}
