@page "/usuarios"
@using MudBlazor
@using API.APIService

<MudGrid Class="mt-0">
    <!-- Grid -->
    <MudItem xs="12" md="10">
        <MudDataGrid @ref="dataGrid"
                     T="UserDTO"
                     ServerData="ServerReload"
                     Dense="true"
                     Hover="true"
                     Bordered="true"
                     Striped="true"
                     RowClick="GotoUser"
                     Class="mt-1 pa-2"
                     Elevation="2">
            <ToolBarContent>
                <MudStack Row AlignItems="AlignItems.Center" Style="width:100%" Class="pa-1 mb-4">

                    <MudSpacer />

                    <!-- Buscar -->
                    <MudTextField T="string"
                                  @bind-Value="Search"
                                  Label="Buscar"
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  AdornmentColor="Color.Primary"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="mt-2 mb-1" />
                    <MudIconButton Icon="@Icons.Material.Filled.Clear" OnClick="ClearFilters" Class="ml-1 mt-2" />
                </MudStack>
            </ToolBarContent>

            <Columns>
                <PropertyColumn Property="x => x.Name"
                                Title="Usuario"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:20%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />
                <PropertyColumn Property="x => x.Email"
                                Title="Email"
                                Sortable="true" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:25%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer" />

                <!-- Configuración de la vista de grupos -->
                <TemplateColumn Title="Grupos" Sortable="false" Filterable="true"
                                HeaderStyle="text-align:left; font-weight:600"
                                CellStyle="width:55%; cursor:pointer">
                    <CellTemplate>
                        @if (context.Item.ListaGrupos is { Count: > 0 })
                        {
                            <div style="display:flex; flex-wrap:wrap; gap:.25rem; align-items:center;">
                                @foreach (var grupos in context.Item.ListaGrupos)
                                {
                                    var label = !string.IsNullOrWhiteSpace(grupos?.Name) ? grupos!.Name : "Grupo sin nombre";
                                    <MudChip Size="Size.Small" Variant="Variant.Outlined" Class="mr-1 mb-1">
                                        @label
                                    </MudChip>
                                }
                            </div>
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">—</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
            </Columns>

            <!-- Paginación -->
            <PagerContent>
                <MudDataGridPager T="UserDTO" RowsPerPageString="Filas por página:" />
            </PagerContent>

        </MudDataGrid>
    </MudItem>
</MudGrid>
